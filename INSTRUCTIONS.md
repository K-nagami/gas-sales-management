# 売上管理統合システム構築指示書

## 概要
Google スプレッドシート1つで「見積→発注→請求→ヨミ管理→ダッシュボード」を統合管理するシステムを構築せよ。
PDF帳票生成・税理士向けCSV出力はGoogle Apps Script（GAS）で実装する。

---

## STEP 1: Google スプレッドシート作成

スプレッドシート名: `売上管理_統合システム`

### シート①「設定」
以下の構成でセルに値を配置する（B列に値、A列にラベル）:

| A列（ラベル） | B列（値） |
|---|---|
| 社名 | （後で入力） |
| 代表者名 | （後で入力） |
| 郵便番号 | 〒000-0000 |
| 住所 | （後で入力） |
| TEL | 000-0000-0000 |
| メール | example@example.com |
| 適格請求書発行事業者番号 | T0000000000000 |
| 振込先銀行 | （後で入力） |
| 振込先支店 | （後で入力） |
| 口座種別 | 普通 |
| 口座番号 | 0000000 |
| 口座名義 | （後で入力） |
| 消費税率 | 0.10 |
| 発注書注意書き | ※本発注書にご署名・ご捺印の上、PDF又は原本をご返送ください。 |
| 支払条件 | 月末締め翌月末払い |
| 帳票保存先フォルダID | （GoogleドライブのフォルダIDを後で入力） |

### シート②「案件マスタ」
1行目にヘッダー:

| 列 | ヘッダー名 | 備考 |
|---|---|---|
| A | 案件ID | AUTO: EST-YYYYMM-001 形式（GASで自動採番） |
| B | 顧客名 | |
| C | 案件名 | |
| D | 見積日 | 日付 |
| E | 発注日 | 日付（空欄可） |
| F | 請求日 | 日付（空欄可） |
| G | 入金予定日 | 日付（空欄可） |
| H | 入金日 | 日付（空欄可） |
| I | ステータス | プルダウン: 見積中 / 発注済 / 請求済 / 入金済 / 失注 |
| J | 見積金額（税抜） | 明細シートから自動集計 |
| K | 消費税 | J × 消費税率（設定シート参照） |
| L | 合計金額 | J + K |
| M | 見積書URL | GASが自動記入 |
| N | 発注書URL | GASが自動記入 |
| O | 請求書URL | GASが自動記入 |
| P | 備考 | |

- I列のプルダウンはデータの入力規則で設定
- J列は SUMIF関数で明細シートの該当案件IDの小計を合算
- K列 = J × 設定!B13（消費税率）
- L列 = J + K

### シート③「明細」
1行目にヘッダー:

| 列 | ヘッダー名 | 備考 |
|---|---|---|
| A | 案件ID | 案件マスタのA列と一致 |
| B | 品目名 | |
| C | 単価 | 数値 |
| D | 数量 | 数値 |
| E | 小計 | C × D |

### シート④「ダッシュボード」
以下のセクションを構築する。データは案件マスタから関数で自動取得。

#### セクション1: 月別ヨミサマリー（B2起点）
- 行: 月（当月〜6ヶ月先）
- 列: 見積中金額 / 発注済金額 / 請求済金額 / 入金済金額 / 合計
- SUMIFS関数でステータス×月で集計

#### セクション2: KPI（B12起点）
- 当月受注率 = 発注済件数 ÷ 見積件数（失注含む）
- 当月売上（請求済合計）
- 当月入金済合計
- 未入金残高（請求済 - 入金済）

#### セクション3: 入金遅延アラート（B18起点）
- 入金予定日 < TODAY() かつ 入金日が空欄 の案件を一覧表示
- FILTER関数で動的抽出

#### セクション4: 顧客別売上（B25起点）
- UNIQUE + SUMIFS で顧客名別の合計金額を集計

#### セクション5: 月別推移チャート用データ（B32起点）
- 過去12ヶ月の月別: 見積件数 / 受注件数 / 売上金額 / 入金金額
- このデータ範囲でグラフ（棒グラフ+折れ線）を作成

---

## STEP 2: Google Apps Script（GAS）実装

スプレッドシートのApps Scriptエディタ（拡張機能 > Apps Script）に以下を実装する。

### 2-1. PDF生成共通基盤

Google ドキュメントのテンプレートを使う方式:
1. 見積書テンプレート（Googleドキュメント）
2. 発注書テンプレート（Googleドキュメント）
3. 請求書テンプレート（Googleドキュメント）

各テンプレート内のプレースホルダー（{{社名}}, {{顧客名}}, {{案件名}} 等）をGASで置換し、PDFに変換してGoogleドライブに保存する。

#### テンプレートのプレースホルダー一覧:
```
{{自社名}}, {{自社住所}}, {{自社TEL}}, {{自社メール}}, {{適格番号}}
{{顧客名}}, {{案件名}}, {{案件ID}}
{{見積日}}, {{発注日}}, {{請求日}}
{{明細テーブル}}  ← 品目名|単価|数量|小計 の表
{{小計}}, {{消費税}}, {{合計金額}}
{{振込先情報}}
{{支払条件}}
{{発注書注意書き}}
{{発注日記入欄}}  ← 発注書のみ: 「発注日:　　年　　月　　日」
{{押印欄}}        ← 発注書のみ: 「ご担当者名:　　　　　　　印」
```

### 2-2. GAS関数一覧

```javascript
// === メニュー追加 ===
function onOpen() {
  // カスタムメニュー「帳票」を追加
  // - 見積書PDF生成
  // - 発注書PDF生成
  // - 請求書PDF生成
  // - 税理士CSV出力
  // - 案件ID自動採番
}

// === 帳票生成 ===
function generateEstimatePDF() {
  // アクティブ行の案件IDを取得
  // 設定シートから自社情報取得
  // 明細シートから該当案件の明細取得
  // 見積書テンプレートを複製→プレースホルダー置換→PDF変換
  // GoogleドライブのフォルダにPDF保存
  // 案件マスタのM列（見積書URL）にURLを記入
}

function generateOrderFormPDF() {
  // 同様の処理で発注書を生成
  // 発注日記入欄・押印欄を含む
  // 案件マスタのN列（発注書URL）にURLを記入
}

function generateInvoicePDF() {
  // 同様の処理で請求書を生成
  // 適格請求書発行事業者番号を含む（インボイス対応）
  // 案件マスタのO列（請求書URL）にURLを記入
}

// === 共通処理 ===
function fillTemplateAndConvertToPDF(templateId, replacements, fileName, folderId) {
  // テンプレートドキュメントをコピー
  // プレースホルダーを置換
  // 明細テーブルは表形式で挿入
  // PDF変換してフォルダに保存
  // 一時コピーを削除
  // PDFのURLを返す
}

function getSettingsData() {
  // 設定シートから全データ取得してオブジェクトで返す
}

function getItemsForProject(projectId) {
  // 明細シートから該当案件IDの行を全取得
}

// === 案件ID自動採番 ===
function assignProjectId() {
  // 案件マスタで案件IDが空欄の行に自動採番
  // 形式: EST-YYYYMM-001（月内の連番）
}

// === 税理士CSV出力 ===
function exportCSVForAccountant() {
  // ダイアログで対象月を入力
  // 請求済み以上のステータスの案件を抽出
  // 列: 請求日, 顧客名, 案件名, 品目名, 単価, 数量, 小計, 消費税, 合計
  // CSVファイルをGoogleドライブに保存
  // ダウンロードリンクを表示
}

// === ステータス変更トリガー ===
function onEdit(e) {
  // ステータス列（I列）が変更されたら:
  // - 「発注済」に変更 → 発注日（E列）にTODAY()を自動入力
  // - 「請求済」に変更 → 請求日（F列）にTODAY()を自動入力
  // - 「入金済」に変更 → 入金日（H列）にTODAY()を自動入力
}
```

### 2-3. Googleドキュメント帳票テンプレート

GASで以下の3つのGoogleドキュメントを自動作成する:

#### 見積書テンプレート
```
【見積書】
見積書番号: {{案件ID}}
発行日: {{見積日}}

{{顧客名}} 御中

下記の通りお見積り申し上げます。

{{自社名}}
{{自社住所}}
TEL: {{自社TEL}}
Email: {{自社メール}}
適格請求書発行事業者番号: {{適格番号}}

【明細】
{{明細テーブル}}

小計:     {{小計}}
消費税:   {{消費税}}
合計金額: {{合計金額}}

有効期限: 発行日より30日間
備考: {{支払条件}}
```

#### 発注書テンプレート
```
【発注書】
関連見積番号: {{案件ID}}

{{自社名}} 御中

下記の通り発注いたします。

【明細】
{{明細テーブル}}

小計:     {{小計}}
消費税:   {{消費税}}
合計金額: {{合計金額}}

支払条件: {{支払条件}}

{{発注書注意書き}}

発注日:          年      月      日
貴社名: {{顧客名}}
ご担当者名:                        印
```

#### 請求書テンプレート
```
【請求書】
請求書番号: {{案件ID}}
発行日: {{請求日}}

{{顧客名}} 御中

下記の通りご請求申し上げます。

{{自社名}}
{{自社住所}}
TEL: {{自社TEL}}
Email: {{自社メール}}
適格請求書発行事業者番号: {{適格番号}}

【明細】
{{明細テーブル}}

小計:     {{小計}}
消費税(10%): {{消費税}}
合計金額: {{合計金額}}

【お振込先】
{{振込先情報}}

お支払期限: {{入金予定日}}
{{支払条件}}
```

---

## STEP 3: 初期設定手順（ユーザー向け）

1. スプレッドシートを開く
2. 「設定」シートに自社情報・振込先を入力
3. Googleドライブに帳票保存用フォルダを作成し、フォルダIDを設定シートに入力
4. Apps Script エディタでスクリプトを確認し、初回実行で権限を承認
5. テスト: サンプルデータで見積書PDFを生成して動作確認

---

## STEP 4: 日常運用フロー

1. 新規案件 → 案件マスタに顧客名・案件名・見積日を入力
2. メニュー「帳票 > 案件ID自動採番」で案件IDが付与される
3. 明細シートに品目を入力
4. 案件マスタのその行を選択 → メニュー「帳票 > 見積書PDF生成」
5. 同時に「帳票 > 発注書PDF生成」で発注書も生成
6. 見積書 + 発注書をメールで送付（URLはM列・N列に自動記録）
7. 客先から発注書返送 → ステータスを「発注済」に変更（発注日が自動入力）
8. 納品後 → ステータスを「請求済」に変更 → 請求書PDF自動生成も可
9. 入金確認 → ステータスを「入金済」に変更
10. 月末 → 「帳票 > 税理士CSV出力」で当月分を出力して税理士に送付

---

## 注意事項
- 明細テーブルのGoogleドキュメントへの挿入は、GASのBody.appendTable()を使用する
- PDF変換はGoogleドキュメントのexportLinks機能を使用する
- 消費税の端数処理は切り捨て（Math.floor）
- 適格請求書（インボイス）要件: 登録番号、税率ごとの消費税額を明記
- ファイル名規則: `[帳票種別]_[案件ID]_[顧客名].pdf`
