# 売上管理統合システム - デプロイ手順書

## 前提条件
- Googleアカウント（Google Workspace推奨）
- Google Apps Script へのアクセス権限
- GoogleドライブにPDF保存用フォルダを事前作成

---

## 手順1: Google Apps Script プロジェクト作成

1. ブラウザで https://script.google.com にアクセス
2. 左上の「新しいプロジェクト」をクリック
3. プロジェクト名を「売上管理_統合システム」に変更（左上のタイトルをクリック）

---

## 手順2: スクリプトファイルの追加

デフォルトの「コード.gs」を含め、5ファイルを作成する。

### ファイル1: setup.gs
1. 左のエディタで「＋」→「スクリプト」をクリック
2. ファイル名を「setup」に設定
3. `setup.gs` の全内容をコピー＆ペースト

### ファイル2: templates.gs
1. 「＋」→「スクリプト」をクリック
2. ファイル名を「templates」に設定
3. `templates.gs` の全内容をコピー＆ペースト

### ファイル3: main.gs
1. デフォルトの「コード.gs」を開く（または新しいスクリプトファイルを作成）
2. ファイル名を「main」に設定
3. `main.gs` の全内容をコピー＆ペースト

**注意:** デフォルトの「コード.gs」の中身は全て削除してから `main.gs` の内容を貼り付ける。

### ファイル4: webapp.gs
1. 「＋」→「スクリプト」をクリック
2. ファイル名を「webapp」に設定
3. `webapp.gs` の全内容をコピー＆ペースト

### ファイル5: webapp.html
1. 「＋」→「HTML」をクリック（※スクリプトではなくHTML）
2. ファイル名を「webapp」に設定（拡張子 `.html` は自動付与）
3. `webapp.html` の全内容をコピー＆ペースト

---

## 手順3: 初回セットアップの実行

1. エディタ上部のドロップダウンで「setup」を選択
2. 「実行」ボタン（▶）をクリック
3. 初回は権限承認ダイアログが表示される：
   - 「権限を確認」をクリック
   - Googleアカウントを選択
   - 「詳細」→「[プロジェクト名]（安全ではないページ）に移動」
   - すべての権限を「許可」

4. 実行ログ（Ctrl+Enter）で進捗を確認：
   ```
   STEP 1: スプレッドシート作成...
   STEP 2: ドキュメントテンプレート作成...
   ...
   === セットアップ完了 ===
   スプレッドシートURL: https://docs.google.com/spreadsheets/d/...
   ```

5. ログに表示されたスプレッドシートURLを開く

---

## 手順4: 設定シートの入力

スプレッドシートの「設定」シートを開き、以下を入力：

| 行 | 項目 | 対応 |
|---|---|---|
| B1 | 社名 | 自社名を入力 |
| B2 | 代表者名 | 代表者名を入力 |
| B3 | 郵便番号 | 〒xxx-xxxx |
| B4 | 住所 | 本社住所を入力 |
| B5 | TEL | 電話番号 |
| B6 | メール | メールアドレス |
| B7 | 適格請求書発行事業者番号 | Tから始まる13桁 |
| B8 | 振込先銀行 | 銀行名 |
| B9 | 振込先支店 | 支店名 |
| B12 | 口座名義 | 口座名義人 |
| B16 | 帳票保存先フォルダID | ※下記参照 |

### フォルダIDの取得方法
1. Googleドライブで帳票保存用フォルダを作成（例:「帳票PDF」）
2. そのフォルダを開く
3. URLの `https://drive.google.com/drive/folders/XXXXX` の `XXXXX` 部分がフォルダID
4. 設定シートのB16セルにこのIDを貼り付け

---

## 手順5: スクリプトをスプレッドシートにバインド

**重要:** 現在のスクリプトはスタンドアロンで作成している。
スプレッドシートのメニュー（帳票メニュー）やonEditトリガーを機能させるには、
スクリプトをスプレッドシートにバインドする必要がある。

### 方法A（推奨）: コンテナバインドスクリプトとして再作成
1. 作成されたスプレッドシートを開く
2. メニュー「拡張機能」→「Apps Script」
3. 開いたエディタに `setup.gs`, `templates.gs`, `main.gs` の3ファイルを追加
4. **setup関数は再実行不要**（既にシートは作成済み）

### 方法B: トリガーの手動設定
1. Apps Script エディタの左メニュー「トリガー」（時計アイコン）をクリック
2. 「トリガーを追加」をクリック
3. 以下の2つのトリガーを設定：

**トリガー1: onOpen**
- 実行する関数: `onOpen`
- イベントのソース: スプレッドシートから
- イベントの種類: 起動時

**トリガー2: onEdit**
- 実行する関数: `onEdit`
- イベントのソース: スプレッドシートから
- イベントの種類: 編集時

---

## 手順6: 動作確認

### 見積書PDFテスト
1. スプレッドシートの「案件マスタ」シートを開く
2. 2行目（EST-202602-001）のセルをクリック
3. メニュー「帳票」→「見積書PDF生成」
4. PDFが生成され、M列にURLが表示されることを確認

### ステータス変更テスト
1. 「案件マスタ」シートの任意の行のI列で「発注済」を選択
2. E列に本日の日付が自動入力されることを確認

---

## 手順7: Web App のデプロイ（管理画面UI）

ダッシュボード・案件管理・新規登録のWebUIを使用するには、Web Appとしてデプロイする。

### 7-1. デプロイの実行
1. Apps Script エディタの右上「デプロイ」→「新しいデプロイ」をクリック
2. 左上の歯車アイコン（⚙）→「ウェブアプリ」を選択
3. 以下を設定：

| 項目 | 設定値 |
|---|---|
| 説明 | 売上管理ダッシュボード v1.0 |
| 次のユーザーとして実行 | 自分 |
| アクセスできるユーザー | 自分のみ（※社内共有する場合は「組織内の全員」） |

4. 「デプロイ」をクリック
5. 初回は再度権限承認が必要（手順3と同様の手順で許可）
6. 表示された **Web App URL** をコピーして保存

### 7-2. アクセス確認
1. コピーしたURLをブラウザで開く
2. 3つのタブが表示されることを確認：
   - **ダッシュボード** — KPI、月次グラフ、ステータス円グラフ、超過アラート
   - **案件管理** — 案件一覧、ステータスフィルタ、詳細モーダル、PDF生成
   - **新規登録** — 案件登録フォーム、明細登録フォーム

### 7-3. コード更新時の再デプロイ
スクリプトを修正した場合、Web Appに反映するには再デプロイが必要：
1. 「デプロイ」→「デプロイを管理」をクリック
2. 右上の鉛筆アイコン（✏）をクリック
3. バージョンを「新しいバージョン」に変更
4. 「デプロイ」をクリック

**注意:** URLは変わらない。「テストデプロイ」のURLは常に最新コードが反映されるため、開発中はテストデプロイURLを使うと便利。

---

## ファイル構成

```
gas-project/
├── setup.gs       ... 初期セットアップ（スプレッドシート・テンプレート作成）
├── templates.gs   ... Googleドキュメントテンプレート生成
├── main.gs        ... メインアプリケーション（PDF・CSV・採番・トリガー）
├── webapp.gs      ... Web App サーバーサイドAPI
├── webapp.html    ... Web App フロントエンドUI
└── DEPLOY_GUIDE.md ... この手順書
```

---

## トラブルシューティング

| 症状 | 原因・対策 |
|---|---|
| 「権限がありません」エラー | 初回実行時の権限承認をやり直す |
| メニューが表示されない | スプレッドシートをリロード / トリガーを確認 |
| PDF生成でフォルダエラー | 設定シートB16のフォルダIDを確認 |
| テンプレートが見つからない | 設定シートB17-B19のIDが空でないか確認 |
| 日付が自動入力されない | onEditトリガーが設定されているか確認 |
| Web Appが「スクリプト関数が見つかりません」 | webapp.gs がプロジェクトに追加されているか確認 |
| Web Appでデータが表示されない | スプレッドシートIDがwebapp.gs内のgetSpreadsheet_()で正しく取得されているか確認。コンテナバインド推奨 |
| Web AppのURLが「アクセスが拒否されました」 | デプロイ設定の「アクセスできるユーザー」を確認 |
| Web Appに変更が反映されない | 「デプロイを管理」→新しいバージョンで再デプロイ。またはテストデプロイURLを使用 |
