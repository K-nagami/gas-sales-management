# 売上管理統合システム — 開発ログ

**リポジトリ**: https://github.com/K-nagami/gas-sales-management
**プラットフォーム**: Google Apps Script + Google Workspace
**開発期間**: 2026年2月

---

## v3.1.0 — 一括請求書生成 + 案件削除（2026-02-09）

### 追加機能

**1. 案件一覧チェックボックス + 一括請求書PDF生成**
- 案件管理テーブル先頭にチェックボックス列を追加
- ヘッダーの全選択チェックボックスで一括ON/OFF
- ツールバーに「一括請求書生成」ボタン（選択件数リアルタイム表示、未選択時は無効化）
- バックエンド `generateBulkInvoices(projectIds)` で複数案件をループ処理
- 明細なし案件はスキップ、エラーは個別キャッチして他の案件に影響させない
- API制限回避のため案件間に500ms待機
- 生成結果サマリー（成功/失敗件数 + 失敗理由）をフロントに返却
- 生成した請求書URLはO列に自動保存

**2. 案件削除機能**
- 案件詳細モーダルに赤い「削除」ボタンを配置（フッター左側）
- 2段階confirmダイアログで誤操作防止
- バックエンド `deleteProject(projectId)` で明細シート → 案件マスタの順に削除
- 明細は下から上へ行削除（スプレッドシートのインデックスずれ防止）
- 削除後にダッシュボード・案件一覧を自動リロード

### 変更ファイル
- `webapp.gs`: `deleteProject()`, `generateBulkInvoices()` 追加（+130行）
- `webapp.html`: チェックボックス列、一括ボタン、削除ボタン、JS関数群追加（+118行）

### コミット
- `bdc508d` feat: 一括請求書生成 + 案件削除機能を追加

---

## v3.0.0 — ステータス別基準日フィルタリング（2026-02-08〜09）

### 変更概要
KPI・ファネルの期間集計を「見積日ベース」から「現ステータスの基準日ベース」に変更。各ステータスが「いつその状態になったか」を正確に追跡可能にした。

### 追加カラム（案件マスタ）
| 列 | カラム名 | 用途 |
|---|---|---|
| R (18) | 登録日 | 案件作成時に自動セット |
| S (19) | 提案日 | ステータスが「提案中」に変更された日 |
| T (20) | 失注日 | ステータスが「失注」に変更された日 |

### ステータス → 基準日マッピング
| ステータス | 基準日列 |
|---|---|
| 商談見込み | R列（登録日） |
| 提案中 | S列（提案日） |
| 見積もり提示 | D列（見積日） |
| 受注 | E列（受注日） |
| 請求済 | F列（請求日） |
| 入金済 | H列（入金日） |
| 失注 | T列（失注日） |

### 追加関数
- `getStatusBaseDate_(row, status)` — ステータスに対応する基準日を返す
- `isInRange_(dateVal, dateRange)` — 日付が期間内か判定
- `migrateV3()` — 既存データにR/S/T列を追加するマイグレーション

### 変更ファイル
- `webapp.gs`: `getDashboardData()` のフィルタリングロジック全面書き換え
- `webapp.gs`: `addNewProject()`, `updateProjectStatus()`, `updateProjectBulk()` にR/S/T列の自動セット追加
- `setup.gs`: `migrateV3()` 追加
- `main.gs`: `onEdit()` にS列・T列の自動入力追加

---

## v2.0.0 — ダッシュボード機能強化（2026-02-08）

### 追加機能

**7段階パイプライン**
- ステータスを7段階に拡張: 商談見込み → 提案中 → 見積もり提示 → 受注 → 請求済 → 入金済 / 失注
- ファネルチャートで各段階の件数・金額・転換率を可視化

**ヨミ管理（売上予測）**
- ヨミランク A/B/C/D（確度 90%/70%/50%/30%）
- 加重売上 = 各案件の金額 × 確度
- KPIカードに確定売上・ヨミ売上・合計見込みを表示
- ランク別パイプライン内訳

**入金ギャップ分析**
- 入金予定日ベースのplanned金額 vs 入金日ベースのactual金額
- 過去6ヶ月〜今後3ヶ月の棒グラフ + ギャップ折れ線

**期間セレクタ**
- 当月 / 1Q / 2Q / 3Q / 4Q / 今期（通年）で切替可能
- 決算月1月・期首2月の会計年度に対応

**案件詳細モーダル**
- 案件IDクリックで詳細表示
- ステータス・ヨミランク・備考をトグルボタンで変更
- 進捗バーリアルタイム更新
- 帳票PDF リンク・明細テーブル表示
- 一括保存ボタン（ステータス+ヨミ+備考を1回のAPI呼出で更新）

### 追加ファイル
- `webapp.gs` — Web Appサーバーサイド（ダッシュボードAPI、CRUD操作）
- `webapp.html` — ダッシュボードUI（Chart.js、モーダル、フォーム）

---

## v1.0.0 — 初期構築（2026-02-08）

### システム概要
Google Apps Script上に構築した売上管理システム。スプレッドシートをデータベースとして使用し、帳票PDF生成・CSV出力・Web Appダッシュボードを提供。

### コアファイル

**setup.gs（628行）**
- `setup()` — スプレッドシート初期構築（案件マスタ・明細・設定・ダッシュボードシート）
- `createSampleData()` — サンプル案件5件+明細データ挿入
- `migrateV2()` — v1→v2マイグレーション（ヨミランク列追加等）
- `migrateV3()` — v2→v3マイグレーション（R/S/T列追加）

**main.gs（811行）**
- `onOpen()` — カスタムメニュー「帳票」作成
- `generateEstimatePDF()` — 見積書PDF生成 → M列にURL保存
- `generateOrderFormPDF()` — 発注書PDF生成 → N列にURL保存
- `generateInvoicePDF()` — 請求書PDF生成 → O列にURL保存
- `fillTemplateAndConvertToPDF()` — PDF生成エンジン（テンプレートクローン → プレースホルダ置換 → PDF変換）
- `buildReplacements_()` — 20+プレースホルダの辞書生成
- `insertItemsTable_()` — 明細テーブル挿入（青ヘッダー #4472C4）
- `exportCSVForAccountant()` — 税理士用CSV出力（BOMエンコード）
- `assignProjectId()` — 案件ID一括自動採番（EST-YYYYMM-NNN形式）
- `onEdit()` — ステータス変更時の日付自動入力トリガー

**templates.gs（273行）**
- `createAllDocumentTemplates()` — 見積書・発注書・請求書のGoogleDocテンプレート自動生成
- 各テンプレートに20+プレースホルダと `{{明細テーブル}}` を埋め込み

**webapp.gs（現在854行）**
- `doGet()` — Web Appエントリーポイント
- `getDashboardData(period)` — ダッシュボード集計API
- `getProjectsList()` — 案件一覧API
- `addNewProject()` / `addNewItem()` — 新規登録
- `updateProjectBulk()` — ステータス・ヨミ・備考一括更新
- `generatePDFFromWeb()` — Web App経由のPDF生成
- `deleteProject()` — 案件+明細削除 ★v3.1追加
- `generateBulkInvoices()` — 一括請求書生成 ★v3.1追加

**webapp.html（現在959行）**
- ダッシュボード: KPIカード、ファネル、月別推移グラフ、入金ギャップ、顧客別売上、入金遅延アラート
- 案件管理: チェックボックス付き一覧、フィルター、一括請求書ボタン、詳細モーダル（削除対応）
- 新規登録: 案件フォーム、明細追加フォーム

### スプレッドシート構造
- **案件マスタ**: A〜T列（20列）— 案件の全情報
- **明細**: A〜E列 — 案件IDリンク、品目名、単価、数量、小計
- **設定**: B1〜B19 — 自社情報、税率、テンプレートID、フォルダID等

### バグ修正履歴
| 日付 | 内容 |
|---|---|
| 2026-02-08 | `doGet()` の `ALLOWALL` XFrameオプションを削除 → postMessageエラー解消 |
| 2026-02-08 | `loadDashboard()` に30秒タイムアウト追加 → 無限ローディング防止 |
| 2026-02-09 | ダークテーマUI → ユーザー判断により元のライトテーマに戻し |

---

## GitHub

**リポジトリ**: https://github.com/K-nagami/gas-sales-management
**公開設定**: Public
**ブランチ**: main
**初回push**: 2026-02-09（commit: `8b00c5d`）
**最新commit**: 2026-02-09（commit: `bdc508d`）
**言語構成**: JavaScript 70.6% / HTML 29.4%
