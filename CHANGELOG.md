# 売上管理統合システム — 開発ログ

**リポジトリ**: https://github.com/K-nagami/gas-sales-management
**プラットフォーム**: Google Apps Script + Google Workspace
**開発期間**: 2026年2月

---

## v5.0.0 — 仕入管理・粗利可視化（2026-02-09）

### 変更概要
案件マスタに仕入情報（U〜AC列）を追加し、仕入先請求書の照合と案件別粗利の可視化を実現。ダッシュボードに粗利KPI、月別推移に粗利ラインを追加。案件管理一覧・詳細モーダルから仕入情報の入力・編集が可能。

### 新機能

**1. 案件マスタ 仕入・粗利列（U〜AC列）**

| 列 | 項目 | 型 |
|:--|:--|:--|
| U(21) | 仕入先名 | テキスト |
| V(22) | 仕入金額（税抜） | 数値 |
| W(23) | 仕入消費税 | 数式 `=FLOOR(V*設定!B13)` |
| X(24) | 仕入合計 | 数式 `=V+W` |
| Y(25) | 仕入先請求番号 | テキスト |
| Z(26) | 支払日 | 日付 |
| AA(27) | 仕入先請求書URL | URL |
| AB(28) | 粗利 | 数式 `=L-X` |
| AC(29) | 粗利率 | 数式 `=IFERROR(AB/L,0)` |

**2. ダッシュボード粗利KPI**
- KPIカードに「粗利合計」追加（受注+請求済+入金済の合計粗利 + 粗利率表示）
- 月別推移グラフに「粗利」ライン追加（緑色破線）

**3. 案件管理 粗利率表示**
- 案件一覧テーブルに「粗利率」列追加（30%以上=緑、0〜30%=黄、マイナス=赤）
- 案件詳細モーダルに仕入合計・粗利・粗利率を表示

**4. 仕入情報入力（モーダル）**
- 案件詳細モーダルに仕入セクション追加
- 入力項目: 仕入先名、仕入金額（税抜）、仕入先請求番号、支払日、仕入先請求書URL
- 保存ボタンで案件情報と仕入情報を同時保存

### 新規API（webapp.gs）
| 関数 | 用途 |
|:--|:--|
| `updateProjectPurchase(projectId, purchaseData)` | 仕入情報の更新（U〜AA列） |

### 変更ファイル
- `setup.gs`: `initProjectMasterSheet_()` にU〜AC列追加、`migrateV5()` 新設
- `webapp.gs`: `getDashboardData()` に粗利KPI追加、`getProjectsList()` に仕入・粗利データ追加、`addNewProject()` に仕入数式追加、`updateProjectPurchase()` 新設
- `webapp.html`: KPIカード粗利追加、月別グラフ粗利ライン追加、案件一覧に粗利率列、モーダルに仕入セクション、saveAll()で仕入同時保存

### 後方互換性
- `migrateV5()` で既存データに列追加+数式セット
- 仕入金額未入力時は粗利=売上合計（仕入0扱い）
- 既存PDFには影響なし

---

## v4.1.0 — 顧客マスタ呼称/名称分離 + 顧客管理UI（2026-02-09）

### 変更概要
顧客マスタに「呼称」（内部管理用）と「名称」（帳票記載用）の分離を導入。同一企業・別担当のケースに対応し、表記ゆれを防止。ダッシュボードに顧客管理タブを新設し、タブ名「新規登録」→「新規案件登録」に変更。

### 設計方針
- 案件マスタB列 = 呼称（内部管理用キー、フリーテキスト入力OK）
- 帳票PDF = 顧客マスタの「名称」を使用。名称未登録時は呼称をフォールバック
- 顧客登録は案件登録と独立。見積もりを出すまでは不要

### 新機能

**1. 顧客マスタ スキーマ変更（8列→9列）**
- 旧: 顧客名 | 郵便番号 | 住所1 | 住所2 | 役職 | 担当者名 | メール | 備考
- 新: 呼称 | 名称 | 郵便番号 | 住所1 | 住所2(ビル名) | 役職 | 担当者名 | メールアドレス | 備考
- `migrateV4b()` で既存データにB列「名称」を挿入し、呼称と同値で初期化

**2. 帳票PDF 名称フォールバック**
- `buildReplacements_()` の `{{顧客名}}` に名称を優先使用
- 名称未入力時は呼称（案件マスタB列）をフォールバック

**3. 顧客管理タブ（ダッシュボード）**
- 登録済み顧客一覧テーブル（呼称 | 名称 | 住所 | 担当者 | 編集ボタン）
- 未登録顧客セクション: 案件マスタにいるが顧客マスタ未登録の呼称を一覧表示+「登録」ボタン
- 新規顧客登録フォーム（呼称*, 名称*, 郵便番号, 住所1, 住所2, 役職, 担当者名, メール, 備考）
- 編集モード: 既存顧客の情報をインラインで修正

**4. 案件登録フォーム改善**
- 顧客名入力欄にdatalist候補表示（顧客マスタの呼称一覧から自動補完）
- 未登録の顧客名もフリーテキストでそのまま入力可能

**5. タブ名変更**
- 「新規登録」→「新規案件登録」

### 新規API（webapp.gs）
| 関数 | 用途 |
|:--|:--|
| `getCustomersList()` | 顧客マスタ全件+未登録顧客リスト取得 |
| `addNewCustomer(formData)` | 新規顧客登録（呼称重複チェック付き） |
| `updateCustomer(formData)` | 既存顧客更新（呼称をキーに検索） |

### 変更ファイル
- `setup.gs`: `createCustomerMasterSheet_()` 9列スキーマ対応、`migrateV4b()` 追加
- `main.gs`: `getCustomerData_()` にdisplayName追加+列インデックスシフト、`buildReplacements_()` 名称フォールバック
- `webapp.gs`: 顧客CRUD 3関数追加（`getCustomersList`, `addNewCustomer`, `updateCustomer`）
- `webapp.html`: タブ名変更、顧客管理タブ追加、datalist候補表示

### 後方互換性
- 案件マスタのスキーマは変更なし（B列=顧客名はそのまま「呼称」として機能）
- `migrateV4b()` 実行で既存顧客マスタを自動変換（呼称=名称で初期化）
- 顧客マスタ未作成でも `getCustomerData_()` は空文字を返す
- 既存PDFには影響なし

---

## v4.0.0 — 帳票テンプレート v4 リデザイン（2026-02-09）

### 変更概要
参照PDF（ミキヤホームズ請求書）のレイアウトをベースに、3帳票（見積書・発注書・請求書）のテンプレートを統一リデザイン。顧客マスタ新設、社印画像対応、明細5列化を含む。

### 新機能

**1. 顧客マスタシート新設**
- ヘッダー: 顧客名 | 郵便番号 | 住所1 | 住所2(ビル名) | 役職 | 担当者名 | メールアドレス | 備考
- `migrateV4()` 実行時に案件マスタB列から既存顧客名を自動抽出してプレースホルダー行作成
- `getCustomerData_()` で顧客名検索、未存在時はグレースフルデグレード

**2. 帳票テンプレート全面リデザイン（3帳票共通）**
- 2カラムボーダレスヘッダーテーブル（左: 宛先情報、右: 発行者情報）
- サマリーテーブル（3列: 小計 | 消費税 | 合計金額）
- 5列明細テーブル（取引日 | 摘要 | 数量 | 単価 | 明細金額）
- 内訳セクション（10%対象税抜 / 10%消費税）
- 枠付き備考欄

**3. 帳票別差分**
- 見積書: 顧客情報（左）+ 自社情報+社印（右）、見積金額ラベル
- 発注書: 自社名御中（左）+ 顧客情報（右）、署名欄テーブル、発注金額ラベル
- 請求書: 顧客情報（左）+ 自社情報+社印（右）、入金・振込テーブル、請求金額ラベル

**4. 社印画像対応**
- 設定シートB22に社印画像ファイルIDを設定
- `insertSealImage_()` でGoogleドキュメント内に80×80px画像を挿入
- ID未設定時はプレースホルダーを削除（エラーにならない）

**5. 設定シート拡張（B20-B22）**
- B20: 自社担当者名、B21: 自社URL、B22: 社印画像ファイルID

### 新規プレースホルダー
| プレースホルダー | データ元 |
|:--|:--|
| `{{顧客郵便番号}}` | 顧客マスタ.B列 |
| `{{顧客住所1}}` | 顧客マスタ.C列 |
| `{{顧客住所2}}` | 顧客マスタ.D列 |
| `{{顧客役職}}` | 顧客マスタ.E列 |
| `{{顧客担当者名}}` | 顧客マスタ.F列 |
| `{{自社担当者名}}` | 設定.B20 |
| `{{自社URL}}` | 設定.B21 |
| `{{社印画像}}` | 設定.B22（画像として挿入） |
| `{{10%対象}}` | 小計と同値（税抜金額） |
| `{{10%消費税}}` | 消費税と同値 |

### 変更ファイル
- `setup.gs`: `migrateV4()`, `createCustomerMasterSheet_()`, `extendSettingsForV4_()` 追加、`initSettingsSheet_()` B20-B22追加
- `main.gs`: `getSettingsData()` B1:B22に拡張、`getCustomerData_()` 新設、`buildReplacements_()` 拡張、`insertItemsTable_()` 5列化、`buildTableDataV4_()` 新設、`insertSealImage_()` 新設、`fillTemplateAndConvertToPDF()` 引数追加、PDF生成3関数更新
- `templates.gs`: 3テンプレート全面書き換え、共通ヘルパー追加（`appendSummaryTable_()`, `appendBreakdownSection_()`, `appendRemarksTable_()`)
- `webapp.gs`: `generatePDFFromWeb()`, `generateBulkInvoices()` に transactionDate/sealImageId 引数追加

### 後方互換性
- 案件マスタのスキーマは変更なし（顧客名は引き続きB列テキスト）
- 顧客マスタ未作成でも `getCustomerData_()` は空文字を返す
- 社印画像ID未設定でもプレースホルダーが削除されるだけ
- 既存PDFには影響なし

---

## v3.1.0 — 一括請求書生成 + 案件削除（2026-02-09）

### 追加機能

**1. 案件一覧チェックボックス + 一括請求書PDF生成**
- 案件管理テーブル先頭にチェックボックス列を追加
- ヘッダーの全選択チェックボックスで一括ON/OFF
- ツールバーに「一括請求書生成」ボタン（選択件数リアルタイム表示、未選択時は無効化）
- バックエンド `generateBulkInvoices(projectIds)` で複数案件をループ処理
- 明細なし案件はスキップ、エラーは個別キャッチして他の案件に影響させない
- API制限回避のため案件間に500ms待機
- 生成結果サマリー（成功/失敗件数 + 失敗理由）をフロントに返却
- 生成した請求書URLはO列に自動保存

**2. 案件削除機能**
- 案件詳細モーダルに赤い「削除」ボタンを配置（フッター左側）
- 2段階confirmダイアログで誤操作防止
- バックエンド `deleteProject(projectId)` で明細シート → 案件マスタの順に削除
- 明細は下から上へ行削除（スプレッドシートのインデックスずれ防止）
- 削除後にダッシュボード・案件一覧を自動リロード

### 変更ファイル
- `webapp.gs`: `deleteProject()`, `generateBulkInvoices()` 追加（+130行）
- `webapp.html`: チェックボックス列、一括ボタン、削除ボタン、JS関数群追加（+118行）

### コミット
- `bdc508d` feat: 一括請求書生成 + 案件削除機能を追加

---

## v3.0.0 — ステータス別基準日フィルタリング（2026-02-08〜09）

### 変更概要
KPI・ファネルの期間集計を「見積日ベース」から「現ステータスの基準日ベース」に変更。各ステータスが「いつその状態になったか」を正確に追跡可能にした。

### 追加カラム（案件マスタ）
| 列 | カラム名 | 用途 |
|---|---|---|
| R (18) | 登録日 | 案件作成時に自動セット |
| S (19) | 提案日 | ステータスが「提案中」に変更された日 |
| T (20) | 失注日 | ステータスが「失注」に変更された日 |

### ステータス → 基準日マッピング
| ステータス | 基準日列 |
|---|---|
| 商談見込み | R列（登録日） |
| 提案中 | S列（提案日） |
| 見積もり提示 | D列（見積日） |
| 受注 | E列（受注日） |
| 請求済 | F列（請求日） |
| 入金済 | H列（入金日） |
| 失注 | T列（失注日） |

### 追加関数
- `getStatusBaseDate_(row, status)` — ステータスに対応する基準日を返す
- `isInRange_(dateVal, dateRange)` — 日付が期間内か判定
- `migrateV3()` — 既存データにR/S/T列を追加するマイグレーション

### 変更ファイル
- `webapp.gs`: `getDashboardData()` のフィルタリングロジック全面書き換え
- `webapp.gs`: `addNewProject()`, `updateProjectStatus()`, `updateProjectBulk()` にR/S/T列の自動セット追加
- `setup.gs`: `migrateV3()` 追加
- `main.gs`: `onEdit()` にS列・T列の自動入力追加

---

## v2.0.0 — ダッシュボード機能強化（2026-02-08）

### 追加機能

**7段階パイプライン**
- ステータスを7段階に拡張: 商談見込み → 提案中 → 見積もり提示 → 受注 → 請求済 → 入金済 / 失注
- ファネルチャートで各段階の件数・金額・転換率を可視化

**ヨミ管理（売上予測）**
- ヨミランク A/B/C/D（確度 90%/70%/50%/30%）
- 加重売上 = 各案件の金額 × 確度
- KPIカードに確定売上・ヨミ売上・合計見込みを表示
- ランク別パイプライン内訳

**入金ギャップ分析**
- 入金予定日ベースのplanned金額 vs 入金日ベースのactual金額
- 過去6ヶ月〜今後3ヶ月の棒グラフ + ギャップ折れ線

**期間セレクタ**
- 当月 / 1Q / 2Q / 3Q / 4Q / 今期（通年）で切替可能
- 決算月1月・期首2月の会計年度に対応

**案件詳細モーダル**
- 案件IDクリックで詳細表示
- ステータス・ヨミランク・備考をトグルボタンで変更
- 進捗バーリアルタイム更新
- 帳票PDF リンク・明細テーブル表示
- 一括保存ボタン（ステータス+ヨミ+備考を1回のAPI呼出で更新）

### 追加ファイル
- `webapp.gs` — Web Appサーバーサイド（ダッシュボードAPI、CRUD操作）
- `webapp.html` — ダッシュボードUI（Chart.js、モーダル、フォーム）

---

## v1.0.0 — 初期構築（2026-02-08）

### システム概要
Google Apps Script上に構築した売上管理システム。スプレッドシートをデータベースとして使用し、帳票PDF生成・CSV出力・Web Appダッシュボードを提供。

### コアファイル

**setup.gs（628行）**
- `setup()` — スプレッドシート初期構築（案件マスタ・明細・設定・ダッシュボードシート）
- `createSampleData()` — サンプル案件5件+明細データ挿入
- `migrateV2()` — v1→v2マイグレーション（ヨミランク列追加等）
- `migrateV3()` — v2→v3マイグレーション（R/S/T列追加）

**main.gs（811行）**
- `onOpen()` — カスタムメニュー「帳票」作成
- `generateEstimatePDF()` — 見積書PDF生成 → M列にURL保存
- `generateOrderFormPDF()` — 発注書PDF生成 → N列にURL保存
- `generateInvoicePDF()` — 請求書PDF生成 → O列にURL保存
- `fillTemplateAndConvertToPDF()` — PDF生成エンジン（テンプレートクローン → プレースホルダ置換 → PDF変換）
- `buildReplacements_()` — 20+プレースホルダの辞書生成
- `insertItemsTable_()` — 明細テーブル挿入（青ヘッダー #4472C4）
- `exportCSVForAccountant()` — 税理士用CSV出力（BOMエンコード）
- `assignProjectId()` — 案件ID一括自動採番（EST-YYYYMM-NNN形式）
- `onEdit()` — ステータス変更時の日付自動入力トリガー

**templates.gs（273行）**
- `createAllDocumentTemplates()` — 見積書・発注書・請求書のGoogleDocテンプレート自動生成
- 各テンプレートに20+プレースホルダと `{{明細テーブル}}` を埋め込み

**webapp.gs（現在854行）**
- `doGet()` — Web Appエントリーポイント
- `getDashboardData(period)` — ダッシュボード集計API
- `getProjectsList()` — 案件一覧API
- `addNewProject()` / `addNewItem()` — 新規登録
- `updateProjectBulk()` — ステータス・ヨミ・備考一括更新
- `generatePDFFromWeb()` — Web App経由のPDF生成
- `deleteProject()` — 案件+明細削除 ★v3.1追加
- `generateBulkInvoices()` — 一括請求書生成 ★v3.1追加

**webapp.html（現在959行）**
- ダッシュボード: KPIカード、ファネル、月別推移グラフ、入金ギャップ、顧客別売上、入金遅延アラート
- 案件管理: チェックボックス付き一覧、フィルター、一括請求書ボタン、詳細モーダル（削除対応）
- 新規登録: 案件フォーム、明細追加フォーム

### スプレッドシート構造
- **案件マスタ**: A〜T列（20列）— 案件の全情報
- **明細**: A〜E列 — 案件IDリンク、品目名、単価、数量、小計
- **設定**: B1〜B19 — 自社情報、税率、テンプレートID、フォルダID等

### バグ修正履歴
| 日付 | 内容 |
|---|---|
| 2026-02-08 | `doGet()` の `ALLOWALL` XFrameオプションを削除 → postMessageエラー解消 |
| 2026-02-08 | `loadDashboard()` に30秒タイムアウト追加 → 無限ローディング防止 |
| 2026-02-09 | ダークテーマUI → ユーザー判断により元のライトテーマに戻し |

---

## GitHub

**リポジトリ**: https://github.com/K-nagami/gas-sales-management
**公開設定**: Public
**ブランチ**: main
**初回push**: 2026-02-09（commit: `8b00c5d`）
**最新commit**: 2026-02-09（commit: `bdc508d`）
**言語構成**: JavaScript 70.6% / HTML 29.4%
